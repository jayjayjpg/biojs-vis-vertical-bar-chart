<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../polymer/iron-icons/iron-icons.html">

<!--
`biojs-vis-vertical-bar-chart`
visualize data in a horizontal bar chart

@demo demo/index.html 
-->

<dom-module id="biojs-vis-vertical-bar-chart">
  <template>
    <style>
      :host {
        display: block;
        position: relative;
        --bar-color: grey;
      }

      :host > ::content .column {
        display: inline-block;
        margin-right: 5px;
        position: absolute;
        bottom: 0;
        cursor: pointer;
      }

      ::content .bar {
        background-color: var(--bar-color);
        position: absolute;
        bottom: 0;
        left: 0;
      }

      .row:after, .row:before {
        content: "";
        clear: both;
        display: block;
      }


      ::content .tooltip {
        opacity: 0;
        padding: 8px 4px;
        position: absolute;
        right: -30px;
        top: 15px;
        border-radius: 4px;
        background-color: var(--tooltip-color);
        color: var(--tooltip-text-color);
        -webkit-transition: opacity .2s ease-in;
        -moz-transition: opacity .2s ease-in;
        -o-transition: opacity .2s ease-in;
        -ms-transition: opacity .2s ease-in;
        transition: opacity .2s ease-in;
      }

      ::content .tooltip.active, 
      ::content .tooltip.focus {
        opacity: 1;
        z-index: 999;
      }

      ::content .column:focus, ::content .tooltip:focus {
        outline: none;
      }

      ::content .column:focus .bar {
        opacity: .8;
      }
    </style>
  </template>

  <script>
    Polymer({

      is: 'biojs-vis-vertical-bar-chart',

      ready: function(){

      },

      properties: {
        width: {
          type: String,
          value: '200px',
        },
        height: {
          type: String,
          value: '100px'
        },
        color: {
          type: String,
          value: '#dd77dd',
          observer: 'changeTheme'
        },
        tooltipColor: {
          type: String,
          value: '#444',
          observer: 'changeTheme'
        },
        tooltipTextColor: {
          type: String,
          value: '#fff',
          observer: 'changeTheme'
        },
        data: {
          type: Array,
          observer: 'renderChart'
        },
        dataLength: {
          type: Number,
          computed: 'computeDataLength(data)'
        },
        dataMax: {
          type: Number,
          computed: 'computeMaxDataPoint(data)'
        }
      },

      computeDataLength(data){
        return data.length;
      },

      computeMaxDataPoint(data) {
        console.log("d3.max data: " + d3.max(data));
        return d3.max(data);
      },

      changeTheme: function(color){
         var updatedColor = '';
         if (color == undefined){
          updatedColor = this.color;
         }
         else {
          updatedColor = color;
         }
         this.customStyle['--bar-color'] = updatedColor;
         this.customStyle['--tooltip-color'] = this.tooltipColor;
         this.customStyle['--tooltip-text-color'] = this.tooltipTextColor;
         this.updateStyles();
      },
      
      renderChart: function(){
        console.log("called render chart and data: " + this.data);
        var self = this;
        var totalWidth = this.pixelPropToNum(this.width);
        var totalHeight = this.pixelPropToNum(this.height);
        
        var selection = d3.select(this)
                     .selectAll(".column")
                     .data(self.data);
        var selectionP = d3.select(this)
                        .selectAll(".column aside")
                        .data(self.data);
        var selectionB = d3.select(this)
                           .selectAll(".bar")
                           .data(self.data);

         d3.select(this)
              .attr("style", function(){
                return "height: " + totalHeight + "px;";
              });

        // ENTER section
         var cols = selection
              .enter()
              .append("div")
              .attr("class","column")
              .attr("tabindex", function(d, i){
                return i * 2;
              })
              .attr("style", function(d, i) {
                  return  "left: " + parseInt((i *  totalWidth / self.dataLength) + i * 4) + "px; height: " + totalHeight + "px; width:" + totalWidth / self.dataLength + "px;";
              })
              .on("mouseover", self.showToolTip)
              .on("mouseout", self.hideToolTip)
              .on("click", self.focusToolTip)
              .on("blur", self.blurToolTip);
           
          cols
              .append("div")
              .attr("class","bar")
              .attr("style", function(d, i) {
                  return "width:" + totalWidth / self.dataLength + "px; height: " + totalHeight * d / self.dataMax +"px;"
              });
            cols
              .append("aside")
              .attr("class","tooltip")
              .attr("tabindex", function(d, i){
                return i * 2 + 1;
              })
             .text(function(d){
                return d + " units";
              }); // where to put the transition??? 
         // UPDATE section
         selection
              .attr("style", function(d, i) {
                  return  "left: " + parseInt((i *  totalWidth / self.dataLength) + i * 4) + "px; height: " + totalHeight + "px; width:" + totalWidth / self.dataLength + "px;";
              });

         selectionP
            .text(function(d){
                return d + " units";
            });


         selectionB
            .transition()
            .duration(1400)
            .ease(d3.easePolyOut)
            .attr("style", function(d, i) {
              return "height: " + totalHeight * d / self.dataMax + "px; width: 100%;";
            });


        // EXIT section 
        selection
            .exit()
            .remove();

      },

      setData: function(d){
        console.log("data from data method: " + d);
        this.setAttribute('data', d);
      },

      pixelPropToNum(str){
        // remove pixels from the config value
        var num = str.trim().slice(0,-2);
        console.log("pixelPropToNum " + num);
        return num;
      },

      showToolTip(d, i){
        d3.select(this)
          .select(".tooltip")
          .classed("active", true);
      },

      hideToolTip(d, i){
        d3.select(this)
          .select(".tooltip")
          .classed("active", false);
      },

      focusToolTip(d, i){
        var tt = d3.select(this)
                .select(".tooltip");
        var ttIsFocused = tt
                            .classed("focus");
           tt
            .classed("focus", !ttIsFocused);
          
      },

      blurToolTip(d, i){
        var tt = d3.select(this)
                  .select(".tooltip");
        tt.classed("focus", false);
      },

      attached: function(){
        this.async(function(){
          this.renderChart();
        });
      }

    });
  </script>
</dom-module>
